#!/usr/bin/env bash
set -euo pipefail

CONF="${XDG_CONFIG_HOME:-$HOME/.config}/tmux-sessionizer/tmux-sessionizer.conf"
query="${1-}"

# --- roots (override with DIRS=(...) in $CONF) ---
ROOTS_NO_RECURSE=(
  "$HOME"
)

ROOTS_RECURSE=(
  "$HOME/uni"
  "$HOME/Projects"
)
[[ -f "$CONF" ]] && source "$CONF"

# --- tools ---
FD="${FD_BIN:-fd}"   # set FD_BIN=fdfind if needed

# --- build candidate list ---
# 1) roots as-is
# 2) subdirs (limit depth to keep it fast)
# 3) files (gitignored by default, common dev depths)
# 1) show ROOTS_NO_RECURSE as single entries only
roots_no_recurse=$(
  printf '%s\n' "${ROOTS_NO_RECURSE[@]}" | awk '{print "D\t" $0}'
)

# 2) show ROOTS_RECURSE as entries + subdirs
roots_recurse=$(
  printf '%s\n' "${ROOTS_RECURSE[@]}" | awk '{print "D\t" $0}'
)

subdirs=$(
  ${FD} -t d -d 2 . "${ROOTS_RECURSE[@]}" 2>/dev/null | awk '{print "D\t" $0}'
)

files=$(
  ${FD} -t f -d 4 . "${ROOTS_RECURSE[@]}" 2>/dev/null | awk '{print "F\t" $0}'
)

candidates=$(printf '%s\n%s\n%s\n%s\n' "$roots_no_recurse" "$roots_recurse" "$subdirs" "$files")

# --- fzf with previews: dirs -> ls -lha; files -> bat ---
# You can press ESC to cancel cleanly.
selection=$(
  printf '%s\n' "$candidates" |
  fzf --prompt='session> ' -q "${query:-}" \
      --delimiter=$'\t' --with-nth=2 \
      --preview '
        if [ {1} = D ]; then
          ls -lha --group-directories-first --color=always -- {2} 2>/dev/null || echo "(no dir)"
        else
          if command -v bat >/dev/null 2>&1; then
            bat --style=numbers --color=always --line-range=:400 -- {2} 2>/dev/null
          else
            head -n 200 -- {2} 2>/dev/null || echo "(no file)"
          fi
        fi
      ' \
      --preview-window=right,50%
) || exit 0

typ=$(cut -f1 <<< "$selection")
path=$(cut -f2- <<< "$selection")

# --- decide target directory & optional file ---
target_dir=""
open_file=""
if [[ "$typ" == "D" ]]; then
  target_dir="$(realpath -- "$path")"
else
  open_file="$(realpath -- "$path")"
  target_dir="$(dirname "$open_file")"
fi


# Session name: prefer git root name if available, else directory basename.
git_root=""
if command -v git >/dev/null && git -C "$target_dir" rev-parse --show-toplevel >/dev/null 2>&1; then
  git_root="$(git -C "$target_dir" rev-parse --show-toplevel)"
fi
session_name="$(basename "${git_root:-$target_dir}" | tr -c '[:alnum:]_-' '_' )"

# If session exists: switch/attach; else create it (cd to target_dir).
if tmux has-session -t "=${session_name}" 2>/dev/null; then
  # We already have a session for this project.
  if [[ -n "${TMUX-}" ]]; then
    tmux switch-client -t "$session_name"
  else
    tmux attach -t "$session_name"
    exit 0
  fi
else
  # Create the session; if a file is selected, start nvim on it, otherwise bare shell.
  if [[ -n "$open_file" ]]; then
    tmux new-session -ds "$session_name" -c "$target_dir" "nvim \"$open_file\""
  else
    tmux new-session -ds "$session_name" -c "$target_dir"
  fi
  if [[ -n "${TMUX-}" ]]; then
    tmux switch-client -t "$session_name"
  else
    tmux attach -t "$session_name"
    exit 0
  fi
fi

# If we’re here, we’re inside tmux and the session is active.
# If a file was chosen and we didn’t already open it (existing session),
# open it in a fresh window and jump to it.
if [[ -n "$open_file" ]]; then
  win_index=$(tmux new-window -P -F "#{window_index}" -t "$session_name" -n "$(basename "$open_file")" -c "$target_dir" "nvim \"$open_file\"")
  tmux select-window -t "${session_name}:${win_index}"
fi

